###* variables
# PKGBUILDUP_LOG="./pkgbuildup_result.log"
# INTEGRITY_CHECK="md5"
# IGNORE_WARN="t"
# DOWNLOAD_OVERWRITE="false"
UPLOAD_CMD="burp -kv %s"

deepin_pkgsite="http://packages.linuxdeepin.com"
# deepin_pkgsite="http://mirrors.ustc.edu.cn" # candidate server
tplname="PKGBUILD.tpl"

###* functions

# variable $tplfile, $pkgverreg, $pkgrelreg, $makepkg and $upload will
# be used, besides, if $FILE_INFO is empty, $pkgname, $url and $filereg
# will be used
update_pkg() {
    local pkgname=$1
    abort_if_var_empty "${pkgname}" "pkgname"
    msg "Package name: ${pkgname}"

    # build default $FILE_INFO which own one file
    if [ -z "${FILE_INFO}" ]; then
        local url=${url:-"${deepin_pkgsite}/deepin/pool/main/d/${pkgname}"}
        local filereg=${filereg:-"${pkgname}_.*?\.tar.gz"}
        local FILE_INFO=("fileurl::md5::${url}::${filereg}")
    fi

    local tplfile=${tplfile:-"./${pkgname}/${tplname}"}
    # local pkgverreg=${pkgverreg:-"git[^~_.-]*"}
    local pkgverreg=${pkgverreg:-"[^-]*~[a-z0-9]+"}
    local pkgrelreg=${pkgrelreg:-""} # ignore this argument

    # TODO
    # local makepkg=${makepkg:-"true"}
    # local upload=${upload:-"true"}

    # local makepkg="false"
    local makepkg=${makepkg:-"true"}
    # local upload="false"
    local upload=${upload:-"true"}

    update_pkgbuild_for_source_site "${tplfile}" "${pkgverreg}" "${pkgrelreg}" "${makepkg}" "${upload}"
}

update_local_git() {
    git add -u .
    git commit -m "Update by pkgbuildup"
}

###* Test

(
    local url="${deepin_pkgsite}/deepin/pool/main/g/grub-themes-deepin"
    local filereg="grub-themes-deepin_.*?\.tar.gz"
    local upload="false"
    update_pkg "grub-themes-deepin"
)
exit

###* Main loop
# (
#     local pkgverreg="[0-9]{2}[^_-]*"
#     update_pkg "deepin-cursor-theme"
# )
# update_pkg "deepin-icon-theme"

(
    local url="${deepin_pkgsite}/deepin/pool/main/c/compiz"
    local filereg="compiz_.*?\.tar.gz"
    local makepkg="true"
    local upload="false"
    update_pkg "deepin-compiz"
)
(
    local upload="false"
    update_pkg "deepin-default-gsettings"
)

update_pkg "deepin-game-center"
update_pkg "deepin-media-player"
update_pkg "deepin-music-player"
update_pkg "deepin-screenshot"
update_pkg "deepin-terminal"
update_pkg "deepin-ui"

# TODO deepin-pygtk-fix
# TODO deepin-vte-plus

#update_local_git

# Local Variables:
# mode: sh
# mode: orgstruct
# End:
