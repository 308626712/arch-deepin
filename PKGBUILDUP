###* variables
# PKGBUILDUP_LOG="./pkgbuildup_result.log"
# INTEGRITY_CHECK="md5"
# IGNORE_WARN="t"
# DOWNLOAD_OVERWRITE="false"
UPLOAD_CMD="burp -kv %s"

# deepin_pkgsite="http://packages.linuxdeepin.com"
deepin_pkgsite="http://mirrors.ustc.edu.cn" # candidate server
tplname="PKGBUILD.tpl"

###* functions

# variable $tplfile, $pkgverreg, $pkgrelreg, $makepkg and $upload will
# be used, besides, if $FILE_INFO is empty, $pkgname, $url and $filereg
# will be used
update_pkgbuild_for_deepin() {
    abort_if_var_empty "${pkgname}" "pkgname"
    local pkgname=${pkgname}
    msg "Package name: ${pkgname}"

    # build default $FILE_INFO which own one file
    if [ -z "${FILE_INFO}" ]; then
        local url=${url:-"${deepin_pkgsite}/deepin/pool/main/d/${pkgname}"}
        local filereg=${filereg:-"${pkgname}_.*?_all\.deb"}
        local FILE_INFO=("filename::md5::${url}::${filereg}")
    fi

    local tplfile=${tplfile:-"./${pkgname}/${tplname}"}
    local pkgverreg=${pkgverreg:-"git[^_.-]*"}
    local pkgrelreg=${pkgrelreg:-""} # ignore this argument

    # local makepkg=${makepkg:-"true"}
    # local upload=${upload:-"true"}

    # local makepkg="false"
    local makepkg="true"
    local upload="false"
    # local upload="true"

    update_pkgbuild_for_source_site "${tplfile}" "${pkgverreg}" "${pkgrelreg}" "${makepkg}" "${upload}"
}

update_local_git() {
    git add -u .
    git commit -m "Update by pkgbuild_update"
}

###** deepin-desktop-environment
update_deepin_desktop_environment() {
    local pkgname="deepin-desktop-environment"
    local filereg="${pkgname}_.*?\.tar\.gz"
    update_pkgbuild_for_deepin
}

###** deepin-desktop-environment-plugins
update_deepin_desktop_environment_plugins() {
    local pkgname="deepin-desktop-environment-plugins"
    local tplfile="./${pkgname}/${tplname}"

    local url="${deepin_pkgsite}/deepin/pool/main/d/${pkgname}"
    local filereg="${pkgname}_.*?_all\.deb"
    local plugreg_1="${pkgname}-clock_.*?_all\.deb"
    local plugreg_2="${pkgname}-weather_.*?_all\.deb"
    local FILE_INFO=("filename::md5::${url}::${filereg}"
                     "plugfile_1::md5plug_1::${url}::${plugreg_1}"
                     "plugfile_2::md5plug_2::${url}::${plugreg_2}"
                     )
    update_pkgbuild_for_deepin
}

###** deepin-notifications
update_deepin_notifications() {
    local pkgname="deepin-notifications"
    update_pkgbuild_for_deepin
}

###** deepin-screenshot
update_deepin_screenshot() {
    local pkgname="deepin-screenshot"
    update_pkgbuild_for_deepin
}

###** deepin-terminal
update_deepin_terminal() {
    local pkgname="deepin-terminal"
    update_pkgbuild_for_deepin
}

###** deepin-webkit
update_deepin_webkit() {
    local pkgname="deepin-webkit"
    local tplfile="./${pkgname}/${tplname}"
    local url="${deepin_pkgsite}/deepin/pool/main/d/${pkgname}"

    local filereg_x86="lib${pkgname}-.*?_i386.deb"
    local filereg_x64="lib${pkgname}-.*?_amd64.deb"

    local FILE_INFO=("filename_x86::md5_x86::${url}::${filereg_x86}"
                     "filename_x64::md5_x64::${url}::${filereg_x64}")
    update_pkgbuild_for_deepin
}

###** deepin-artwork
update_deepin_artwork() {
    local pkgname="deepin-artwork"
    local pkgverreg="[0-9]{2}[^_-]*"
    update_pkgbuild_for_deepin
}

###** deepin-icon-theme
update_deepin_icon_theme() {
    local pkgname="deepin-icon-theme"
    update_pkgbuild_for_deepin
}

###** deepin-cursor-theme
update_deepin_cursor_theme() {
    local pkgname="deepin-cursor-theme"
    local pkgverreg="[0-9]{2}[^_-]*"
    update_pkgbuild_for_deepin
}


###** deepin-gtk-theme
update_deepin_gtk_theme() {
    local pkgname="deepin-gtk-theme"
    update_pkgbuild_for_deepin
}

###** deepin-system-tray
update_deepin_system_tray() {
    local pkgname="deepin-system-tray"
    update_pkgbuild_for_deepin
}

###** deepin-system-settings
update_deepin_system_settings() {
    local pkgname="deepin-system-settings"
    local tplfile="./${pkgname}/${tplname}"
    local url="${deepin_pkgsite}/deepin/pool/main/d/${pkgname}"

    # build $FILE_INFO
    local filereg="${pkgname}_.*?_all\.deb"
    local FILE_INFO[0]="filename::md5::${url}::${filereg}"

    local modules="all a11y account application-associate bluetooth \
                   driver mouse power printer system-information \
                   touchpad tray-power mount-media date-time desktop \
                   display individuation keyboard network sound"
    local i=1;
    for mod in $modules; do
        local FILE_INFO[${i}]="modname_${i}::md5mod_${i}::${url}::${pkgname}-module-${mod}_.*?_all\.deb"
        ((i++))
    done

    update_pkgbuild_for_deepin
}

###** deepin-webapps
update_deepin_webapps() {
    local pkgname="deepin-webapps"
    local tplfile="./${pkgname}/${tplname}"
    local url="${deepin_pkgsite}/deepin/pool/main/d/${pkgname}"

    # build $FILE_INFO
    local webapps="kuwo-music dbank-online-storage youdao-note chainrxn \
                   doit-im microsoft-skydrive baidu-map douban ttpod \
                   kugou-music kingsoft-fast-docs xiami-music cargo-bridge \
                   sina-weibo pirateslovedaisies kingsoft-online-storage \
                   baidu-music baidu-online-storage paulrouget towerim \
                   fetion baidu-hi 12306"
    local i=1;
    for app in ${webapps}; do
        local FILE_INFO["$(expr ${i}-1)"]="filename_${i}::md5_${i}::${url}::${pkgname}-${app}_.*?_all\.deb"
        ((i++))
    done

    local pkgverreg="[0-9]+\.[0-9]+[^-_]*"
    update_pkgbuild_for_deepin
}

###** deepin-default-wallpapers
update_deepin_default_wallpapers() {
    local pkgname="deepin-default-wallpapers"
    local url="${deepin_pkgsite}/deepin/pool/main/d/deepin-wallpapers"
    update_pkgbuild_for_deepin
}

###** deepin-media-player
update_deepin_media_player() {
    local pkgname="deepin-media-player"
    update_pkgbuild_for_deepin
}

###** deepin-music-player
update_deepin_music_player() {
    local pkgname="deepin-music-player"
    update_pkgbuild_for_deepin
}

###** deepin-ui
update_deepin_ui() {
    local pkgname="deepin-ui"
    local filereg="${pkgname}_.*?\.tar\.gz"
    update_pkgbuild_for_deepin
}

###** OUT python2-deepin-xrandr
# update_python2_deepin_xrandr() {
#     local pkgname="python2-deepin-xrandr"
#     local url="${deepin_pkgsite}/deepin/pool/main/d/deepin-xrandr"
#     local filereg="deepin-xrandr_.*?\.tar\.gz"
#     update_pkgbuild_for_deepin
# }

###** deepin-compiz
update_deepin_compiz() {
    local pkgname="deepin-compiz"
    local url="${deepin_pkgsite}/deepin/pool/main/c/compiz"
    local pkgverreg="\d+\.\d+\.\d+"
    local PKGREL_CMD="grep -oP '\-\d+_' | tr -d '\-_'"
    local pkgrelreg=""

    local filereg_x86="${pkgname}_.*?_i386.deb"
    local filereg_x64="${pkgname}_.*?_amd64.deb"

    local FILE_INFO=("filename_x86::md5_x86::${url}::${filereg_x86}"
                     "filename_x64::md5_x64::${url}::${filereg_x64}")

    update_pkgbuild_for_deepin
}

###* main
# update_deepin_desktop_environment
# update_deepin_desktop_environment_plugins
# update_deepin_notifications
# update_deepin_screenshot
# update_deepin_terminal
# # update_deepin_webkit
# update_deepin_artwork
# # update_deepin_icon_theme
# update_deepin_cursor_theme
# # update_deepin_gtk_theme
# update_deepin_system_tray
# update_deepin_system_settings
# update_deepin_webapps
# update_deepin_default_wallpapers

# update_deepin_media_player
# update_deepin_music_player
# update_deepin_ui

update_deepin_compiz

# update_local_git

# Local Variables:
# mode: sh
# mode: orgstruct
# End:
